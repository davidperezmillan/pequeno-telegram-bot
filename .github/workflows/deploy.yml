name: Deploy to Portainer

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Portainer
      run: |
        echo "ğŸš€ Iniciando despliegue automÃ¡tico a Portainer..."
        echo "ğŸ“… Timestamp: $(date)"
        echo "ğŸ”— Webhook URL: http://portainer.davidperezmillan.com/api/stacks/webhooks/c4d9b771-5795-409d-9704-3edfee7c0f73"
        echo "ğŸ“¤ Enviando peticiÃ³n POST al webhook..."
        
        # Ejecutar curl y capturar el cÃ³digo de respuesta
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://portainer.davidperezmillan.com/api/stacks/webhooks/c4d9b771-5795-409d-9704-3edfee7c0f73)
        
        echo "ğŸ“Š CÃ³digo de respuesta HTTP: $response"
        
        if [ "$response" -eq 200 ] || [ "$response" -eq 204 ]; then
          echo "âœ… Despliegue activado exitosamente en Portainer"
          echo "â±ï¸  Esperando que Portainer complete el despliegue..."
        else
          echo "âŒ Error al activar el despliegue. CÃ³digo de respuesta: $response"
          exit 1
        fi
        
        echo "ğŸ‰ Proceso de despliegue completado"